<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#050202" />
  <meta name="description" content="Moloch Grove — Rituale digitale. Interfaccia cupa con fuoco volumetrico, gufo animato e terminale oracolare." />
  <title>Moloch Grove | Rituale</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --bg: #020101;
      --fg: #e7e5e4;
      --muted: #a8a29e;
      --stone: #292524;
      --ink: rgba(0,0,0,0.55);
      --red: #dc2626;
      --deepred: #7f1d1d;
      --amber: #fbbf24;
      --gold: #f59e0b;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      /* Subtle noise */
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
    }

    h1, h2, h3, .ritual-font { font-family: 'Cinzel', serif; }

    /* --- Entrance --- */
    @keyframes fadeInDown {
      0% { opacity: 0; transform: translateY(-22px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .animate-enter { animation: fadeInDown 1s cubic-bezier(0.2, 0.8, 0.2, 1) both; }

    /* --- Title flicker (subtle, not disco) --- */
    @keyframes flicker {
      0%, 100% { opacity: 1; text-shadow: 0 0 18px rgba(220, 38, 38, 0.55), 0 0 60px rgba(0,0,0,0.5); }
      50% { opacity: 0.86; text-shadow: 0 0 30px rgba(220, 38, 38, 0.35), 0 0 70px rgba(0,0,0,0.55); }
    }
    .flicker-text { animation: flicker 5.6s infinite alternate; }

    /* --- Ambient vignette + ember haze layer --- */
    .vignette {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background:
        radial-gradient(1200px 800px at 50% 25%, rgba(127,29,29,0.18), transparent 60%),
        radial-gradient(900px 600px at 50% 100%, rgba(245,158,11,0.08), transparent 60%),
        radial-gradient(1200px 900px at 50% 50%, transparent 35%, rgba(0,0,0,0.75) 72%, rgba(0,0,0,0.92) 100%);
    }

    /* --- Reduced motion policy --- */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
      #fireContainer, #emberCanvas { display: none !important; }
      .shake-screen { animation: none !important; }
    }

    /* --- Earthquake (Optimized) --- */
    @keyframes earthquake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-0.5deg); }
      20% { transform: translate(-2px, 0px) rotate(0.5deg); }
      30% { transform: translate(2px, 1px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(0.5deg); }
      50% { transform: translate(-1px, 1px) rotate(-0.5deg); }
      60% { transform: translate(-2px, 1px) rotate(0deg); }
      70% { transform: translate(2px, 1px) rotate(-0.5deg); }
      80% { transform: translate(-1px, -1px) rotate(0.5deg); }
      90% { transform: translate(1px, 1px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-0.5deg); }
    }
    .shake-screen { animation: earthquake 0.3s infinite; will-change: transform; }

    /* --- Input --- */
    .input-ritual {
      background: rgba(10, 10, 10, 0.56);
      border: 1px solid rgba(41,37,36,0.9);
      transition: border-color .25s ease, box-shadow .25s ease, background .25s ease, transform .25s ease;
      backdrop-filter: blur(6px);
      font-family: 'Cinzel', serif;
      letter-spacing: 0.06em;
    }
    .input-ritual:focus {
      border-color: rgba(127,29,29,0.95);
      box-shadow: 0 0 34px rgba(127, 29, 29, 0.22), inset 0 0 12px rgba(0,0,0,0.5);
      outline: none;
      background: rgba(0,0,0,0.78);
      transform: translateY(-1px);
    }
    .input-ritual::placeholder {
      font-family: 'Inter', sans-serif;
      font-size: 0.78em;
      letter-spacing: 0.02em;
      opacity: 0.6;
    }

    /* --- Owl Animations --- */
    @keyframes owlBreath {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-2px) scale(1.01); }
    }
    @keyframes owlTilt {
      0%, 100% { transform: rotate(-0.4deg); }
      50% { transform: rotate(0.4deg); }
    }
    .owl-container {
      transition: box-shadow 1.2s ease, border-color 1.2s ease, transform 1.2s ease;
      animation: owlBreath 6s ease-in-out infinite;
      transform-origin: 50% 60%;
      will-change: transform, box-shadow;
    }
    .owl-tilt { animation: owlTilt 8s ease-in-out infinite; }
    
    /* Subtle pulse when typing */
    .owl-reading {
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.1));
    }

    /* Eye Colors */
    .eye-base { transition: fill 1.2s ease, filter 1.2s ease, transform 0.2s ease; transform-origin: center; }
    .eyes-red { fill: var(--red); filter: drop-shadow(0 0 16px rgba(239,68,68,0.95)); }
    .eyes-gold { fill: var(--amber); filter: drop-shadow(0 0 16px rgba(245,158,11,0.85)); }
    .eyes-dark { fill: #44403c; filter: drop-shadow(0 0 2px #000); }

    /* Owl Container Glows */
    .glow-red { box-shadow: 0 0 120px -12px rgba(220, 38, 38, 0.75), 0 0 40px rgba(0,0,0,0.9) inset; border-color: rgba(127, 29, 29, 1); transform: scale(1.05); }
    .glow-gold { box-shadow: 0 0 120px -12px rgba(245, 158, 11, 0.65), 0 0 40px rgba(0,0,0,0.9) inset; border-color: rgba(180, 83, 9, 1); transform: scale(1.05); }
    .glow-neutral { box-shadow: 0 0 60px -18px rgba(0,0,0,0.95), 0 0 28px rgba(0,0,0,0.9) inset; border-color: rgba(41,37,36,0.85); }

    /* Animated smoke ring around owl */
    .owl-smoke {
      position: absolute;
      inset: -18px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 50%, rgba(127,29,29,0.0) 42%, rgba(127,29,29,0.18) 58%, rgba(0,0,0,0) 70%),
        radial-gradient(circle at 35% 40%, rgba(245,158,11,0.08), transparent 55%),
        radial-gradient(circle at 65% 60%, rgba(220,38,38,0.09), transparent 55%);
      filter: blur(10px);
      opacity: 0.35;
      mix-blend-mode: screen;
      animation: smokeOrbit 9s linear infinite;
      pointer-events: none;
    }
    @keyframes smokeOrbit {
      0% { transform: rotate(0deg) scale(1); opacity: 0.28; }
      50% { transform: rotate(180deg) scale(1.02); opacity: 0.42; }
      100% { transform: rotate(360deg) scale(1); opacity: 0.28; }
    }

    /* --- Terminal --- */
    .terminal-bg {
      background-color: #070404;
      background-image:
        linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.28) 50%),
        linear-gradient(90deg, rgba(255, 0, 0, 0.025), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.025));
      background-size: 100% 3px, 3px 100%;
      border-top: 1px solid rgba(41,37,36,0.75);
    }

    /* Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.25); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(120,113,108,0.35); border-radius: 999px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(220,38,38,0.35); }

    /* --- Buttons --- */
    .btn-ritual {
      position: relative;
      overflow: hidden;
      transition: transform .18s cubic-bezier(0.4, 0, 0.2, 1), box-shadow .18s ease, border-color .18s ease;
      border: 1px solid;
      will-change: transform;
    }
    .btn-ritual:active { transform: scale(0.92); }

    .btn-curse {
      background: linear-gradient(160deg, #110404 0%, #3a0707 60%, #450a0a 100%);
      border-color: rgba(127, 29, 29, 0.9);
    }
    .btn-curse:hover { box-shadow: 0 0 34px rgba(220, 38, 38, 0.38); border-color: rgba(239, 68, 68, 0.95); }

    .btn-bless {
      background: linear-gradient(160deg, #140d04 0%, #331303 65%, #451a03 100%);
      border-color: rgba(120, 53, 15, 0.9);
    }
    .btn-bless:hover { box-shadow: 0 0 34px rgba(245, 158, 11, 0.28); border-color: rgba(251, 191, 36, 0.95); }

    /* shimmer */
    @keyframes shimmer {
      0% { transform: translateX(-120%) skewX(-12deg); opacity: 0.0; }
      35% { opacity: 0.10; }
      100% { transform: translateX(120%) skewX(-12deg); opacity: 0.0; }
    }

    /* --- Fire layers (2D CSS + optional canvas embers) --- */
    .fire-container {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%;
      height: 46vh;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
      mask-image: linear-gradient(to top, black 22%, transparent 100%);
      -webkit-mask-image: linear-gradient(to top, black 22%, transparent 100%);
      filter: saturate(1.1);
    }

    /* base glow */
    .fire-glow {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(700px 260px at 50% 98%, rgba(220,38,38,0.24), transparent 65%),
        radial-gradient(650px 260px at 40% 100%, rgba(245,158,11,0.17), transparent 62%),
        radial-gradient(650px 260px at 60% 100%, rgba(251,191,36,0.10), transparent 62%);
      filter: blur(6px);
      opacity: 0.9;
      animation: glowPulse 5.2s ease-in-out infinite;
    }
    @keyframes glowPulse {
      0%, 100% { opacity: 0.72; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-6px); }
    }

    .fire-particle {
      position: absolute;
      bottom: -34px;
      width: 44px; height: 44px;
      background:
        radial-gradient(circle at 50% 65%, rgba(255, 200, 120, 0.34) 0%, rgba(245,158,11,0.22) 22%, rgba(220,38,38,0.42) 48%, rgba(0,0,0,0) 72%),
        radial-gradient(circle at 50% 80%, rgba(0,0,0,0.22) 0%, rgba(0,0,0,0) 70%);
      border-radius: 999px 999px 999px 999px / 900px 900px 1400px 1400px;
      opacity: 0;
      animation: rise 4.8s infinite ease-in;
      filter: blur(9px) saturate(1.2);
      mix-blend-mode: screen;
      will-change: transform, opacity;
    }

    .fire-tongue {
      position: absolute;
      bottom: -10vh;
      width: 26vw;
      max-width: 220px;
      height: 44vh;
      background:
        radial-gradient(closest-side at 50% 90%, rgba(251,191,36,0.14), rgba(245,158,11,0.08), rgba(220,38,38,0.06), transparent 70%),
        linear-gradient(to top, rgba(220,38,38,0.14), rgba(245,158,11,0.06), transparent 60%);
      border-radius: 60% 40% 50% 50% / 65% 65% 35% 35%;
      filter: blur(18px) saturate(1.2);
      opacity: 0.22;
      mix-blend-mode: screen;
      transform-origin: 50% 90%;
      animation: tongue 3.6s ease-in-out infinite;
      will-change: transform, opacity;
    }

    @keyframes rise {
      0% { opacity: 0; transform: translateY(0) translateX(0) scale(0.9, 0.9) rotate(-2deg); }
      18% { opacity: 0.42; }
      55% { opacity: 0.7; transform: translateY(-140px) translateX(10px) scale(1.05, 1.55) rotate(2deg); }
      100% { opacity: 0; transform: translateY(-380px) translateX(-12px) scale(0.65, 1.15) rotate(-2deg); }
    }

    @keyframes tongue {
      0%, 100% { transform: translateY(0) scaleY(1) rotate(-1.2deg); opacity: 0.18; }
      35% { transform: translateY(-14px) scaleY(1.06) rotate(1.2deg); opacity: 0.28; }
      70% { transform: translateY(-8px) scaleY(1.03) rotate(-0.6deg); opacity: 0.22; }
    }

    /* heat haze */
    .heat-haze {
      position: absolute;
      inset: 0;
      background: radial-gradient(900px 360px at 50% 100%, rgba(255,255,255,0.05), transparent 70%);
      opacity: 0.22;
      filter: blur(2px);
      animation: haze 3.8s ease-in-out infinite;
      mix-blend-mode: overlay;
    }
    @keyframes haze {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-10px) scale(1.02); }
    }

    /* Loader */
    .loader {
      width: 4px;
      height: 4px;
      background-color: currentColor;
      box-shadow: 0 0 10px currentColor;
      border-radius: 50%;
      animation: loaderPulse 1s infinite alternate;
      position: relative;
    }
    .loader:before, .loader:after {
      content: "";
      position: absolute;
      width: 4px; height: 4px;
      background-color: currentColor;
      border-radius: 50%;
      animation: loaderPulse 1s infinite alternate;
    }
    .loader:before { left: -10px; animation-delay: 0.2s; }
    .loader:after { right: -10px; animation-delay: 0.4s; }
    @keyframes loaderPulse { 0% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }

    /* Accessibility: focus */
    :focus-visible { outline: 2px solid rgba(251,191,36,0.25); outline-offset: 2px; }

    /* Embers canvas */
    #emberCanvas{
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.55;
    }

    /* Flash overlay */
    .flash-overlay{
      position: fixed;
      inset: 0;
      z-index: 50;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1.4s ease-out;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4 relative selection:bg-red-900 selection:text-white">

  <!-- Canvas Embers -->
  <canvas id="emberCanvas" aria-hidden="true"></canvas>

  <!-- FIRE BACKGROUND -->
  <div class="fire-container" id="fireContainer" aria-hidden="true">
    <div class="fire-glow"></div>
    <div class="heat-haze"></div>
    <!-- Particles injected by JS -->
  </div>

  <!-- Vignette -->
  <div class="vignette" aria-hidden="true"></div>

  <!-- MAIN WRAPPER -->
  <div class="relative z-10 w-full max-w-lg flex flex-col items-center transition-transform duration-300 transform-gpu" id="mainContainer">

    <!-- HEADER / OWL -->
    <header class="mb-4 md:mb-8 text-center animate-enter w-full flex flex-col items-center justify-center">

      <div id="owlContainer" class="owl-container owl-tilt glow-neutral inline-block p-8 md:p-12 rounded-full border-2 bg-stone-950/90 mb-4 md:mb-8 relative overflow-hidden">
        <div class="owl-smoke" aria-hidden="true"></div>

        <!-- SVG -->
        <svg class="w-32 h-32 md:w-48 md:h-48 text-stone-300" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <!-- Horns/Ears -->
          <path d="M20 35 L15 10 L35 25 L50 15 L65 25 L85 10 L80 35" stroke-width="2" />

          <!-- Head -->
          <path d="M20 35 C10 55, 15 85, 30 95 L50 100 L70 95 C85 85, 90 55, 80 35" fill="#0c0a09" stroke-width="2"/>

          <!-- Inner lines -->
          <path d="M35 55 Q50 65 65 55" stroke-opacity="0.25" />
          <path d="M50 35 L50 50" stroke-opacity="0.25" />

          <!-- Sockets -->
          <circle cx="35" cy="45" r="11" stroke="none" fill="#1c1917" />
          <circle cx="65" cy="45" r="11" stroke="none" fill="#1c1917" />

          <!-- Pupils -->
          <circle id="eyeLeft" cx="35" cy="45" r="5" class="eye-base eyes-dark" />
          <circle id="eyeRight" cx="65" cy="45" r="5" class="eye-base eyes-dark" />

          <!-- Beak -->
          <path d="M50 60 L44 75 L56 75 Z" fill="#292524" stroke="none" />

          <!-- Wing hints -->
          <path d="M10 60 Q0 80 20 85" stroke-opacity="0.35" />
          <path d="M90 60 Q100 80 80 85" stroke-opacity="0.35" />
        </svg>
      </div>

      <h1 class="text-5xl md:text-6xl text-stone-100 font-black tracking-widest ritual-font flicker-text mb-2 drop-shadow-2xl">MOLOCH</h1>
      <div class="h-px w-24 md:w-32 bg-gradient-to-r from-transparent via-red-900 to-transparent mb-1"></div>
      <p class="text-stone-500 uppercase tracking-[0.5em] text-[10px] font-bold">Cremation of Care</p>
    </header>

    <!-- CARD -->
    <main class="w-full bg-[#070707]/92 border border-stone-800/60 shadow-[0_0_90px_rgba(0,0,0,1)] rounded-xl overflow-hidden backdrop-blur-xl animate-enter" style="animation-delay: 0.12s;">
      <div class="p-6 md:p-8 space-y-6 md:space-y-8">

        <!-- Input -->
        <div class="relative group">
          <div class="absolute inset-0 bg-red-900/12 blur-xl rounded-full opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
          <input
            type="text"
            id="targetName"
            placeholder="NOME O DESIDERIO"
            class="relative w-full py-4 text-stone-200 rounded-lg input-ritual placeholder-stone-700 text-xl md:text-2xl font-bold bg-black/40 text-center uppercase focus:text-white"
            autocomplete="off"
            enterkeyhint="go"
            maxlength="60"
            aria-label="Nome o desiderio"
          />
</div>

        <!-- Buttons -->
        <div class="grid grid-cols-2 gap-4 md:gap-5">
          <button type="button" id="btnBless" class="btn-ritual btn-bless group text-amber-100 py-5 md:py-6 rounded-lg active:bg-amber-900/40 touch-manipulation">
            <div class="relative z-10 flex flex-col items-center gap-2">
              <i data-lucide="sun" class="w-5 h-5 md:w-6 md:h-6 text-amber-500/80 group-hover:scale-110 group-hover:rotate-45 transition-transform duration-500" aria-hidden="true"></i>
              <span class="ritual-font font-bold tracking-[0.18em] text-[10px] uppercase">Benedizione</span>
            </div>
            <div class="absolute inset-0 -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] bg-gradient-to-r from-transparent via-white/6 to-transparent skew-x-12" style="animation-name: shimmer;"></div>
          </button>

          <button type="button" id="btnCurse" class="btn-ritual btn-curse group text-red-100 py-5 md:py-6 rounded-lg active:bg-red-900/40 touch-manipulation">
            <div class="relative z-10 flex flex-col items-center gap-2">
              <i data-lucide="flame" class="w-5 h-5 md:w-6 md:h-6 text-red-500/80 group-hover:scale-110 transition-transform duration-300" aria-hidden="true"></i>
              <span class="ritual-font font-bold tracking-[0.18em] text-[10px] uppercase">Maledizione</span>
            </div>
            <div class="absolute inset-0 -translate-x-full group-hover:animate-[shimmer_1.5s_infinite] bg-gradient-to-r from-transparent via-white/6 to-transparent skew-x-12" style="animation-name: shimmer;"></div>
          </button>
        </div>

        <!-- Loader -->
        <div id="loadingIndicator" class="hidden flex justify-center py-2 h-8" aria-live="polite" aria-atomic="true">
          <div class="relative text-stone-500 flex flex-col items-center gap-2">
            <div class="loader"></div>
            <span class="text-[9px] uppercase tracking-widest opacity-70">Generazione Oracolo...</span>
          </div>
        </div>
      </div>

      <!-- Log / Output -->
      <div class="terminal-bg p-4 md:p-6 h-40 md:h-48 overflow-y-auto custom-scrollbar text-center text-stone-500 scroll-smooth" id="consoleLog" role="log" aria-live="polite" aria-relevant="additions">
        <div class="opacity-30 mt-10 md:mt-12 flex flex-col gap-2" id="idleHint">
          <span class="font-serif italic text-sm">~ Attesa del Sacrificio ~</span>
        </div>
      </div>
    </main>

    <footer class="mt-8 md:mt-12 text-stone-800 text-[9px] font-mono relative z-10 text-center tracking-widest opacity-30 uppercase hover:opacity-100 transition-opacity pb-6">
      Grove Council • MMXXIV
    </footer>
  </div>

  <div id="flash" class="flash-overlay" aria-hidden="true"></div>

  <script>
    (function () {
      try { lucide.createIcons(); } catch (e) {}

      const consoleLog = document.getElementById('consoleLog');
      const idleHint = document.getElementById('idleHint');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const input = document.getElementById('targetName');
      const owlContainer = document.getElementById('owlContainer');
      const eyeLeft = document.getElementById('eyeLeft');
      const eyeRight = document.getElementById('eyeRight');
      const fireContainer = document.getElementById('fireContainer');
      const flash = document.getElementById('flash');

      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // OWL REACTIVITY (Eye Tracking Simulation)
      input.addEventListener('input', () => {
         eyeLeft.style.transform = `scale(${1 + Math.random()*0.1})`;
         eyeRight.style.transform = `scale(${1 + Math.random()*0.1})`;
         owlContainer.classList.add('owl-reading');
         clearTimeout(window.owlTimer);
         window.owlTimer = setTimeout(() => {
             eyeLeft.style.transform = 'scale(1)';
             eyeRight.style.transform = 'scale(1)';
             owlContainer.classList.remove('owl-reading');
         }, 500);
      });

      // ---- FIRE PARTICLES (CSS layer) ----
      function createFireParticles() {
        if (!fireContainer || prefersReduced) return;
        const isMobile = window.innerWidth < 768;
        const count = isMobile ? 20 : 38;
        const frag = document.createDocumentFragment();

        for (let i = 0; i < count; i++) {
          const p = document.createElement('div');
          p.className = 'fire-particle';
          const left = Math.random() * 100;
          const size = 16 + Math.random() * (isMobile ? 34 : 58);
          const delay = Math.random() * 5.2;
          const dur = 3.2 + Math.random() * 4.6;
          p.style.left = left.toFixed(2) + '%';
          p.style.width = size.toFixed(0) + 'px';
          p.style.height = size.toFixed(0) + 'px';
          p.style.animationDelay = delay.toFixed(2) + 's';
          p.style.animationDuration = dur.toFixed(2) + 's';
          frag.appendChild(p);
        }

        const tongues = isMobile ? 3 : 5;
        for (let i = 0; i < tongues; i++) {
          const t = document.createElement('div');
          t.className = 'fire-tongue';
          t.style.left = (10 + Math.random() * 80).toFixed(2) + '%';
          t.style.animationDelay = (Math.random() * 1.8).toFixed(2) + 's';
          t.style.animationDuration = (3.0 + Math.random() * 2.6).toFixed(2) + 's';
          frag.appendChild(t);
        }

        fireContainer.appendChild(frag);
      }
      createFireParticles();

      // ---- EMBERS CANVAS ----
      const canvas = document.getElementById('emberCanvas');
      const ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
      let embers = [];

      function resizeCanvas() {
        if (!canvas || !ctx) return;
        const dpr = Math.min(2, window.devicePixelRatio || 1);
        canvas.width = Math.floor(window.innerWidth * dpr);
        canvas.height = Math.floor(window.innerHeight * dpr);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      function spawnEmber() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const x = Math.random() * w;
        const y = h + 10;
        const vy = - (0.6 + Math.random() * 1.6);
        const vx = (Math.random() - 0.5) * 0.7;
        const r = 0.6 + Math.random() * 1.8;
        const life = 140 + Math.random() * 160;
        const hueRoll = Math.random();
        const color = hueRoll > 0.7 ? 'rgba(251,191,36,' : (hueRoll > 0.4 ? 'rgba(245,158,11,' : 'rgba(220,38,38,');
        embers.push({ x, y, vx, vy, r, life, max: life, color, drift: (Math.random() - 0.5) * 0.25 });
      }

      function stepEmbers() {
        if (!canvas || !ctx || prefersReduced) return;
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        
        const isMobile = window.innerWidth < 768;
        const spawnN = isMobile ? 1 : 2;
        if(Math.random() > 0.5) { for (let i = 0; i < spawnN; i++) spawnEmber(); }

        embers = embers.filter(e => e.life > 0);
        for (const e of embers) {
          e.life -= 1;
          const t = e.life / e.max;
          e.vx += e.drift * 0.02;
          e.x += e.vx;
          e.y += e.vy;
          e.vy *= 0.995;
          const alpha = Math.max(0, Math.min(0.85, t));
          ctx.beginPath();
          ctx.fillStyle = e.color + alpha.toFixed(3) + ')';
          ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2);
          ctx.fill();
        }
        requestAnimationFrame(stepEmbers);
      }

      if (canvas && ctx && !prefersReduced) {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas, { passive: true });
        stepEmbers();
      }

      // ---- VOCABULARY ----
      const vocab = {
        bless: {
          openers: [ "Sotto l'ala del Gufo Eterno,", "Dalle ceneri del bosco sacro,", "Tra i rami antichi che toccano il cielo,", "Quando l'alba bacia la rugiada,", "Oltre il velo della notte oscura," ],
          actions: [ "la luce dorata discende piano.", "il vento porta antiche promesse.", "si apre un sentiero di stelle.", "la linfa scorre nuova e forte.", "gli spiriti benevoli si radunano." ],
          effects: [ "Che la fortuna ti sia compagna,", "Ogni passo diventi una danza,", "Il peso del mondo svanisce ora,", "La saggezza guidi il tuo cuore,", "L'abbondanza fiorisca al tuo tocco," ],
          closers: [ "e la pace trovi la tua dimora.", "verso un domani che splende d'oro.", "sotto il manto della grande quercia.", "sigillato nel patto della luce.", "custodito dal sacro fuoco." ]
        },
        curse: {
          openers: [ "Nel vuoto dove il Moloch attende,", "Sotto la terra fredda e spoglia,", "Quando la luna si tinge di sangue,", "Dalle profondità del bosco cieco,", "Al rintocco dell'ora tredicesima," ],
          actions: [ "l'ombra si allunga e ti avvolge.", "il fuoco brucia ogni speranza.", "un gelido vento chiama il tuo nome.", "gli spettri ridono nel buio.", "il sentiero si chiude per sempre." ],
          effects: [ "Che il sonno ti sia per sempre negato,", "Ogni strada diventi un labirinto,", "Il peso del giudizio ti schiacci,", "La sfortuna sia la tua unica ombra,", "Il tuo nome sia sussurrato con timore," ],
          closers: [ "finché il debito non sarà pagato.", "nel silenzio eterno della notte.", "senza riparo dal nostro sguardo.", "sigillato nel patto della cenere.", "sotto l'occhio che tutto vede." ]
        }
      };

      function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
      function generateAIPoem(type) {
        const s = vocab[type];
        return [pick(s.openers), pick(s.actions), pick(s.effects), pick(s.closers)];
      }

      function setOwlState(state) {
        owlContainer.classList.remove('glow-neutral', 'glow-gold', 'glow-red');
        eyeLeft.classList.remove('eyes-dark', 'eyes-gold', 'eyes-red');
        eyeRight.classList.remove('eyes-dark', 'eyes-gold', 'eyes-red');

        if (state === 'bless') {
          owlContainer.classList.add('glow-gold');
          eyeLeft.classList.add('eyes-gold');
          eyeRight.classList.add('eyes-gold');
        } else if (state === 'curse') {
          owlContainer.classList.add('glow-red');
          eyeLeft.classList.add('eyes-red');
          eyeRight.classList.add('eyes-red');
        } else {
          owlContainer.classList.add('glow-neutral');
          eyeLeft.classList.add('eyes-dark');
          eyeRight.classList.add('eyes-dark');
        }
      }

      // TYPEWRITER EFFECT
      async function logLine(text, type) {
        const div = document.createElement('div');
        div.className = 'mb-2 font-mono text-xs md:text-sm tracking-wide leading-relaxed';
        if (type === 'bless') div.style.color = '#fbbf24';
        else if (type === 'curse') div.style.color = '#ef4444';
        else div.style.color = '#a8a29e';
        
        consoleLog.appendChild(div);
        consoleLog.scrollTop = consoleLog.scrollHeight;

        // Type letter by letter
        for (let i = 0; i < text.length; i++) {
            div.textContent += text[i];
            // Random delay between keystrokes for realism
            await wait(15 + Math.random() * 20); 
        }
      }

      function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

      function shakeInput(el) {
        el.classList.add('border-red-900');
        el.animate([
          { transform: 'translateX(0)' },
          { transform: 'translateX(-6px)' },
          { transform: 'translateX(6px)' },
          { transform: 'translateX(0)' }
        ], { duration: 360 });
        setTimeout(() => el.classList.remove('border-red-900'), 900);
      }

      function toggleEarthquake(active) {
        if (prefersReduced) return;
        if (active) {
          // Applying to main container prevents scrollbar jitter on body
          document.getElementById('mainContainer').classList.add('shake-screen');
          if (navigator.vibrate) navigator.vibrate([40, 50, 40]);
        } else {
          document.getElementById('mainContainer').classList.remove('shake-screen');
        }
      }

      function flashOverlay(type) {
        if (!flash) return;
        if (type === 'bless') {
          flash.style.background = 'radial-gradient(circle at 50% 50%, rgba(251,191,36,0.30) 0%, transparent 70%)';
          flash.style.mixBlendMode = 'screen';
        } else {
          flash.style.background = 'radial-gradient(circle at 50% 50%, rgba(220,38,38,0.35) 0%, transparent 70%)';
          flash.style.mixBlendMode = 'overlay';
        }
        flash.style.opacity = '1';
        setTimeout(() => { flash.style.opacity = '0'; }, 100);
      }

      async function performRitual(type) {
        const name = (input.value || '').trim();
        if (!name) {
          shakeInput(input);
          input.focus();
          return;
        }

        input.disabled = true;
        input.style.opacity = '0.55';
        loadingIndicator.classList.remove('hidden');
        consoleLog.innerHTML = ''; // Clear log

        setOwlState(type);
        toggleEarthquake(true);

        try {
          await logLine(`INVOCANDO PER: ${name.toUpperCase()}`, 'neutral');
          await wait(800);

          const poemLines = generateAIPoem(type);
          for (let i = 0; i < poemLines.length; i++) {
            await logLine(poemLines[i], type);
            // Flash on last line
            if (i === poemLines.length - 1) flashOverlay(type);
            await wait(300); 
          }

          await wait(350);
          await logLine(type === 'bless' ? 'COSÌ SIA.' : 'IL PATTO È CHIUSO.', type);

        } finally {
          toggleEarthquake(false);
          await wait(1500);
          setOwlState('neutral');
          loadingIndicator.classList.add('hidden');
          input.disabled = false;
          input.style.opacity = '1';
          input.value = '';
          input.focus();
        }
      }

      document.getElementById('btnBless').addEventListener('click', () => performRitual('bless'));
      document.getElementById('btnCurse').addEventListener('click', () => performRitual('curse'));

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          performRitual(e.shiftKey ? 'curse' : 'bless');
        }
      });

      // idle focus
      setTimeout(() => { input.focus(); }, 300);

    })();
  </script>
</body>
</html>
